# Day18笔记

### async和await如何工作

1. **`async` 方法和状态机**
   * **`async` 方法** ：当你在一个方法前加上 `async` 关键字时，编译器会将这个方法转换成一个状态机。这个状态机负责跟踪异步操作的执行状态。
   * **状态机** ：编译器生成的状态机包含了处理异步操作的逻辑，包括管理异步操作的开始、等待和完成状态。它还负责在异步操作完成时恢复执行。
2. **`await` 关键字**
   * **暂停执行** ：`await` 用于等待异步操作的完成。它会暂停当前方法的执行，并允许其他代码（如 UI 更新或其他任务）在等待期间运行。
   * **恢复执行** ：当异步操作完成时，状态机会恢复方法的执行，并继续处理后续的代码。

### 状态机和执行流程

1. **创建状态机** ：
   * 当编译器编译一个 `async` 方法时，它会生成一个包含多个状态的状态机。每个状态表示方法执行的不同阶段（如任务开始、等待、任务完成等）。
2. **异步操作和状态机** ：
   * 在方法内部，当遇到 `await` 表达式时，编译器会生成代码来保存当前的执行上下文和状态，然后将执行控制权返回给调用者。
   * 当异步操作完成后，状态机会恢复执行，并从 `await` 表达式之后的代码开始继续执行。
3. **回调和继续执行** ：
   * `await` 表达式会将任务的继续执行注册为回调。当任务完成时，回调会被触发，状态机会恢复执行异步方法中的后续代码。

### UI 线程和线程恢复

1. **UI 线程恢复** ：
   * 在 UI 应用程序中（如 WPF 或 Windows Forms），`await` 操作会尽量将异步操作的恢复继续在原来的 UI 线程上执行。这是因为 UI 元素只能在创建它们的线程上进行更新，通常是主 UI 线程。
   * 当 `await` 表达式遇到一个尚未完成的 `Task` 时，`await` 会释放当前线程（UI 线程），让它去处理其他事情（如用户输入）。
   * 当异步操作完成后，`await` 会尝试将恢复的执行回到原来的 UI 线程上继续执行后续的代码。这是通过 `SynchronizationContext` 实现的，确保 UI 元素能够安全地进行更新。
2. **线程池线程恢复** ：
   * 在非 UI 应用程序（如控制台应用程序或后台服务）中，`await` 后的代码可能会在任意线程池线程上恢复。这是因为在这种情况下，没有特定的上下文（如 UI 线程），所以恢复的线程可能是线程池中的任何线程。
   * 如果 `await` 后的代码是在某个线程池线程上执行的（例如，通过 `Task.Run` 提交的任务），那么恢复的线程将是线程池中的线程。

### 线程的使用

`async` 和 `await` 不直接控制线程的创建，而是通过操作系统或线程池的机制来处理异步操作。具体来说，`async` 和 `await` 如何处理线程，取决于异步操作的类型和实现：

1. **I/O 操作**
   
   * **异步 I/O** ：对于网络请求、文件读写等 I/O 操作，`async` 和 `await` 并不直接涉及线程创建。它们通常依赖于操作系统的异步 I/O 操作。这些操作在后台进行，线程会被释放，以便其他任务可以使用它。
   * **例子** ：使用 `HttpClient` 发起异步 HTTP 请求，`await` 不会创建新线程，而是利用操作系统的 I/O 完成通知机制来异步处理请求。
   
2. **计算密集型操作**
   
   * **`Task.Run`** ：如果你在 `async` 方法中使用 `Task.Run` 来执行计算密集型任务，它会在线程池中创建一个新线程。这样可以在后台线程上运行计算密集型工作，从而不会阻塞主线程。
   
3. **UI 线程和异步编程**
   
   * **UI 应用程序** ：在桌面应用程序（如 WPF 或 Windows Forms）中，`await` 会确保在异步操作完成后，继续在原来的线程（通常是 UI 线程）上恢复执行。这有助于保持 UI 的响应性，并避免线程问题。
   

### 总结

* **`async` 和 `await`** 使得异步编程更简单，通过生成状态机来管理异步操作。
* **线程创建** ：`async` 和 `await` 本身不直接创建新线程，依赖于操作系统的异步 I/O 机制或线程池来处理异步任务。
* **异步操作** ：对于 I/O 操作，`async` 和 `await` 不涉及新线程。对于计算密集型任务，如果在 `async` 方法中使用 `Task.Run`，它会使用线程池中的线程。
* **UI 线程** ：在 UI 应用中，`await` 确保异步操作完成后，恢复执行的线程是原始调用线程（如 UI 线程），保持 UI 响应性。

